<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaEdificio â€” Control de Agua</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0f1a; --surface:#111827; --surface2:#1a2235; --border:#1e2d45;
    --accent:#00d4ff; --accent2:#0095ff; --green:#00e5a0; --yellow:#ffd166;
    --red:#ff6b6b; --text:#e8f0fe; --muted:#6b7a99;
    --font-display:'Syne',sans-serif; --font-mono:'DM Mono',monospace; --font-body:'DM Sans',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(0,212,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;}
  header{position:sticky;top:0;z-index:100;background:rgba(10,15,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:64px;gap:1rem;}
  .logo{font-family:var(--font-display);font-size:1.3rem;font-weight:800;letter-spacing:-1px;flex-shrink:0;}
  .logo span{color:var(--accent);}
  .tabs{display:flex;gap:.2rem;flex-wrap:wrap;}
  .tab{font-family:var(--font-body);font-size:.8rem;font-weight:500;padding:.4rem .85rem;border-radius:6px;border:none;cursor:pointer;background:transparent;color:var(--muted);transition:.2s;}
  .tab:hover{color:var(--text);background:var(--surface2);}
  .tab.active{background:var(--accent);color:#000;font-weight:700;}
  .auth-bar{display:flex;align-items:center;gap:.6rem;flex-shrink:0;}
  .sync-chip{font-size:.72rem;padding:.2rem .55rem;border-radius:4px;display:flex;align-items:center;gap:.3rem;white-space:nowrap;}
  .sync-ok{background:rgba(0,229,160,.15);color:var(--green);}
  .sync-pending{background:rgba(255,209,102,.15);color:var(--yellow);}
  .sync-error{background:rgba(255,107,107,.15);color:var(--red);}
  .auth-avatar{width:26px;height:26px;border-radius:50%;border:2px solid var(--accent);}
  main{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:2rem;}
  .panel{display:none;animation:fadeIn .3s ease;}
  .panel.active{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

  /* LOGIN */
  .login-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:72vh;text-align:center;gap:1.5rem;}
  .login-icon{font-size:3.5rem;}
  .login-title{font-family:var(--font-display);font-size:2rem;font-weight:800;letter-spacing:-1px;}
  .login-sub{color:var(--muted);max-width:380px;line-height:1.65;font-size:.9rem;}
  .btn-google{display:inline-flex;align-items:center;gap:.75rem;background:#fff;color:#1f2937;border:none;border-radius:8px;padding:.75rem 1.5rem;font-family:var(--font-body);font-size:.9rem;font-weight:600;cursor:pointer;transition:.2s;box-shadow:0 2px 12px rgba(0,0,0,.35);}
  .btn-google:hover{background:#f3f4f6;transform:translateY(-1px);}
  .btn-google svg{width:20px;height:20px;}
  .features-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem;margin-top:.5rem;max-width:600px;}
  .feature{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.9rem;text-align:left;}
  .feature-icon{font-size:1.3rem;margin-bottom:.35rem;}
  .feature-title{font-size:.82rem;font-weight:600;margin-bottom:.2rem;}
  .feature-desc{font-size:.72rem;color:var(--muted);line-height:1.4;}

  /* CARDS */
  .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:2rem;}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem;position:relative;overflow:hidden;}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
  .card.green::before{background:linear-gradient(90deg,var(--green),#00b377);}
  .card.yellow::before{background:linear-gradient(90deg,var(--yellow),#e6a000);}
  .card.red::before{background:linear-gradient(90deg,var(--red),#cc3333);}
  .card-label{font-size:.72rem;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem;}
  .card-value{font-family:var(--font-mono);font-size:1.8rem;font-weight:500;color:var(--text);line-height:1;}
  .card-sub{font-size:.78rem;color:var(--muted);margin-top:.35rem;}
  .card-icon{position:absolute;right:1rem;top:1rem;font-size:1.5rem;opacity:.15;}
  .section-title{font-family:var(--font-display);font-size:1.2rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.6rem;}
  .section-title::after{content:'';flex:1;height:1px;background:var(--border);}
  .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:2rem;}
  table{width:100%;border-collapse:collapse;}
  th{background:var(--surface2);font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:500;padding:.75rem 1rem;text-align:left;border-bottom:1px solid var(--border);}
  td{padding:.85rem 1rem;font-size:.88rem;border-bottom:1px solid rgba(30,45,69,.5);}
  tr:last-child td{border-bottom:none;}
  tr:hover td{background:rgba(0,212,255,.03);}
  .badge{display:inline-block;padding:.2rem .6rem;border-radius:4px;font-size:.72rem;font-weight:500;font-family:var(--font-mono);}
  .badge-blue{background:rgba(0,212,255,.15);color:var(--accent);}
  .badge-green{background:rgba(0,229,160,.15);color:var(--green);}
  .badge-yellow{background:rgba(255,209,102,.15);color:var(--yellow);}
  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;}
  .field{display:flex;flex-direction:column;gap:.4rem;}
  label{font-size:.78rem;color:var(--muted);font-weight:500;letter-spacing:.04em;}
  input,select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-body);font-size:.9rem;padding:.65rem .9rem;outline:none;transition:.2s;width:100%;}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,212,255,.1);}
  select option{background:var(--surface2);}
  .btn{display:inline-flex;align-items:center;gap:.5rem;background:var(--accent);color:#000;border:none;border-radius:8px;padding:.7rem 1.4rem;font-family:var(--font-body);font-size:.9rem;font-weight:700;cursor:pointer;transition:.2s;}
  .btn:hover{background:#00b8d9;transform:translateY(-1px);}
  .btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
  .btn-ghost:hover{background:var(--surface2);color:var(--text);}
  .btn-green{background:var(--green);}
  .btn-green:hover{background:#00c288;}
  .upload-area{border:2px dashed var(--border);border-radius:12px;padding:1.5rem;text-align:center;cursor:pointer;transition:.2s;position:relative;}
  .upload-area:hover{border-color:var(--accent);background:rgba(0,212,255,.04);}
  .upload-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
  .foto-preview{display:none;background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-top:.75rem;}
  .foto-preview-head{padding:.6rem 1rem;background:var(--surface2);border-bottom:1px solid var(--border);font-size:.78rem;color:var(--muted);display:flex;align-items:center;justify-content:space-between;}
  .foto-preview-body{display:flex;gap:1rem;padding:1rem;align-items:center;flex-wrap:wrap;}
  .dist-row{display:flex;align-items:center;padding:.9rem 1rem;border-bottom:1px solid rgba(30,45,69,.5);gap:1rem;}
  .dist-row:last-child{border-bottom:none;}
  .dist-name{font-weight:500;flex:1;}
  .dist-bar-wrap{flex:2;height:6px;background:var(--border);border-radius:99px;overflow:hidden;}
  .dist-bar{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:.5s;}
  .dist-m3{font-family:var(--font-mono);color:var(--accent);min-width:80px;text-align:right;}
  .dist-pct{font-family:var(--font-mono);color:var(--muted);font-size:.8rem;min-width:50px;text-align:right;}
  .dist-monto{font-family:var(--font-mono);font-weight:700;color:var(--green);min-width:100px;text-align:right;}

  /* REPORTE */
  .cobro-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;gap:1rem;}
  .cobro-nombre{font-weight:600;font-size:.95rem;}
  .cobro-detalle{font-size:.75rem;color:var(--muted);margin-top:.15rem;}
  .cobro-monto{font-family:var(--font-mono);font-size:1.3rem;font-weight:700;color:var(--green);flex-shrink:0;}

  /* CHART */
  .chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem;}
  .chart-bars{display:flex;align-items:flex-end;gap:.5rem;height:110px;margin-top:.75rem;}
  .chart-col{display:flex;flex-direction:column;align-items:center;gap:.25rem;flex:1;}
  .chart-bar{width:100%;border-radius:4px 4px 0 0;background:linear-gradient(180deg,var(--accent),var(--accent2));min-height:4px;transition:.6s;}
  .chart-lbl{font-size:.62rem;color:var(--muted);}
  .chart-val{font-family:var(--font-mono);font-size:.62rem;color:var(--accent);}

  /* LOADING */
  .loading-overlay{position:fixed;inset:0;background:rgba(10,15,26,.88);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;gap:1rem;backdrop-filter:blur(4px);}
  .loading-overlay.show{display:flex;}
  .spinner{font-size:2rem;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  #toast{position:fixed;bottom:2rem;right:2rem;z-index:99999;padding:.75rem 1.25rem;border-radius:8px;font-weight:700;font-size:.85rem;transform:translateY(100px);opacity:0;transition:.3s;pointer-events:none;}
  #toast.show{transform:translateY(0);opacity:1;}
  .month-selector{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;}
  .month-btn{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:.4rem .8rem;color:var(--text);cursor:pointer;font-size:.9rem;transition:.2s;}
  .month-btn:hover{border-color:var(--accent);}
  .month-current{font-family:var(--font-display);font-size:1rem;font-weight:700;min-width:160px;text-align:center;}
  @media(max-width:640px){
    header{padding:0 .75rem;flex-wrap:wrap;height:auto;padding-top:.5rem;padding-bottom:.5rem;gap:.4rem;}
    .tabs .tab{padding:.35rem .5rem;font-size:.72rem;}
    main{padding:1rem;}
    .dist-bar-wrap{display:none;}
  }
</style>
</head>
<body>

<header>
  <div class="logo">Aqua<span>Edificio</span></div>
  <nav class="tabs" id="main-tabs" style="display:none">
    <button class="tab active" data-panel="dashboard">ğŸ“Š Panel</button>
    <button class="tab" data-panel="registro">ğŸ“· Lectura</button>
    <button class="tab" data-panel="distribucion">ğŸ’§ DistribuciÃ³n</button>
    <button class="tab" data-panel="historial">ğŸ“‹ Historial</button>
    <button class="tab" data-panel="reporte">ğŸŒ Reporte</button>
    <button class="tab" data-panel="config">âš™ï¸ Config</button>
  </nav>
  <div class="auth-bar">
    <span class="sync-chip" id="sync-chip" style="display:none"></span>
    <img class="auth-avatar" id="user-avatar" src="" alt="" style="display:none">
    <button class="btn btn-ghost" id="btn-logout" style="display:none;padding:.35rem .75rem;font-size:.78rem" onclick="signOut()">Salir</button>
  </div>
</header>

<main>

  <!-- ===== LOGIN ===== -->
  <div id="login-screen" class="login-wrap">
    <div class="login-icon">ğŸ’§</div>
    <div class="login-title">AquaEdificio</div>
    <div class="login-sub">Control de consumo de agua del edificio. Datos guardados en tu Google Drive â€” seguros, siempre disponibles, desde cualquier dispositivo.</div>
    <button class="btn-google" id="btn-login">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continuar con Google
    </button>
    <div class="features-grid">
      <div class="feature"><div class="feature-icon">â˜ï¸</div><div class="feature-title">Drive nativo</div><div class="feature-desc">Datos en tu propio Google Drive, no en servidores externos</div></div>
      <div class="feature"><div class="feature-icon">ğŸ“±</div><div class="feature-title">Multidispositivo</div><div class="feature-desc">Accede desde tu celular, tablet o computador</div></div>
      <div class="feature"><div class="feature-icon">ğŸ“·</div><div class="feature-title">Fotos en Drive</div><div class="feature-desc">Las fotos de medidores se guardan en tu carpeta AquaEdificio/</div></div>
      <div class="feature"><div class="feature-icon">ğŸŒ</div><div class="feature-title">Reporte vecinos</div><div class="feature-desc">Comparte un link de solo lectura con los cobros del mes</div></div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="app" style="display:none">

    <!-- DASHBOARD -->
    <div id="panel-dashboard" class="panel active">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.5rem">
        <div class="month-selector" style="margin-bottom:0">
          <button class="month-btn" id="btn-prev">â—€</button>
          <div class="month-current" id="monthLabel">â€”</div>
          <button class="month-btn" id="btn-next">â–¶</button>
        </div>
        <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;font-size:.82rem;color:var(--muted);user-select:none">
          <div class="toggle-wrap" id="toggle-d11" onclick="toggleIndep()" style="width:36px;height:20px;background:var(--border);border-radius:99px;position:relative;cursor:pointer;transition:.2s">
            <div id="toggle-knob" style="position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:var(--muted);transition:.2s"></div>
          </div>
          Mostrar Depto 11
        </label>
      </div>
      <div class="cards-grid">
        <div class="card"><div class="card-icon">ğŸ”µ</div><div class="card-label">Consumo General</div><div class="card-value" id="dash-general">â€” mÂ³</div><div class="card-sub" id="dash-general-sub">Sin lectura</div></div>
        <div class="card green"><div class="card-icon">ğŸ </div><div class="card-label">Depto Independiente</div><div class="card-value" id="dash-indep">â€” mÂ³</div><div class="card-sub">Medidor propio</div></div>
        <div class="card yellow"><div class="card-icon">ğŸŒ¿</div><div class="card-label">Zonas Comunes</div><div class="card-value" id="dash-comun">â€” mÂ³</div><div class="card-sub">Espacios compartidos</div></div>
        <div class="card red"><div class="card-icon">ğŸ’°</div><div class="card-label">Total Factura</div><div class="card-value" id="dash-total">$â€”</div><div class="card-sub" id="dash-tarifa-info">â€”</div></div>
      </div>
      <div class="section-title">Estado lecturas del mes</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Unidad</th><th>Tipo</th><th>Anterior</th><th>Actual</th><th>Consumo</th><th>Estado</th></tr></thead>
        <tbody id="estado-table"></tbody>
      </table></div>
    </div>

    <!-- REGISTRO -->
    <div id="panel-registro" class="panel">
      <div class="section-title">ğŸ“· Registrar Lectura</div>
      <div class="form-grid" style="margin-bottom:1.25rem">
        <div class="field"><label>MES / AÃ‘O</label><input type="month" id="reg-mes"/></div>
        <div class="field"><label>UNIDAD / MEDIDOR</label><select id="reg-unidad"></select></div>
        <div class="field"><label>VALOR EN MÂ³</label><input type="number" id="reg-valor" placeholder="Ej: 1523.45" step="0.01" min="0"/></div>
        <div class="field"><label>NOTAS (opcional)</label><input type="text" id="reg-notas" placeholder="Ej: Medidor con barro"/></div>
      </div>
      <div class="field" style="margin-bottom:1.25rem">
        <label>ğŸ“· FOTO DEL MEDIDOR</label>
        <div class="upload-area">
          <input type="file" accept="image/*" id="foto-input" capture="environment"/>
          <div style="font-size:2rem;margin-bottom:.4rem">ğŸ“·</div>
          <div style="color:var(--muted);font-size:.85rem">Toca para sacar foto o subir imagen<br><span style="font-size:.75rem;color:var(--accent)">Se sube automÃ¡ticamente a tu Google Drive</span></div>
        </div>
        <div class="foto-preview" id="foto-preview">
          <div class="foto-preview-head">
            <span>ğŸ“· Foto lista</span>
            <button class="btn btn-ghost" style="padding:.25rem .6rem;font-size:.75rem;color:var(--red);border-color:var(--red)" id="clear-foto-btn">âœ• Quitar</button>
          </div>
          <div class="foto-preview-body">
            <img id="preview-img" src="" style="height:100px;border-radius:6px;border:1px solid var(--border);object-fit:cover;max-width:150px"/>
            <div style="font-size:.82rem;color:var(--muted)">Se subirÃ¡ a Drive al guardar la lectura.</div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:2.5rem">
        <button class="btn btn-green" id="save-lectura-btn">ğŸ’¾ Guardar en Drive</button>
        <button class="btn btn-ghost" id="clear-form-btn">âœ• Limpiar</button>
      </div>
      <div class="section-title">Lecturas del mes</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Unidad</th><th>Valor (mÂ³)</th><th>Consumo</th><th>Foto</th><th>Notas</th><th></th><th></th></tr></thead>
        <tbody id="reg-table"></tbody>
      </table></div>
    </div>

    <!-- DISTRIBUCIÃ“N -->
    <div id="panel-distribucion" class="panel">
      <div class="section-title">ğŸ’§ DistribuciÃ³n de Costos</div>
      <div class="form-grid" style="margin-bottom:1.5rem">
        <div class="field"><label>MES A DISTRIBUIR</label><input type="month" id="dist-mes"/></div>
        <div class="field"><label>MONTO TOTAL FACTURA ($)</label><input type="number" id="dist-monto" placeholder="Ej: 45000"/></div>
        <div class="field" style="justify-content:flex-end"><button class="btn btn-green" id="calc-btn">âš¡ Calcular</button></div>
      </div>
      <div class="table-wrap" id="dist-container"><div style="padding:2rem;text-align:center;color:var(--muted)">Selecciona mes y monto para calcular</div></div>
      <div style="margin-top:1rem;display:flex;gap:.75rem;flex-wrap:wrap">
        <button class="btn btn-ghost" id="export-btn" style="display:none">ğŸ“„ TXT</button>
        <button class="btn btn-green" id="export-pdf-btn" style="display:none">ğŸ“‹ Exportar PDF</button>
        <button class="btn btn-ghost" id="share-btn" style="display:none">ğŸ”— Copiar link</button>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div id="panel-historial" class="panel">
      <div class="section-title">ğŸ“‹ Historial Completo</div>
      <div class="chart-wrap" id="chart-wrap" style="display:none">
        <div style="font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em">Consumo mensual â€” Medidor General (mÂ³)</div>
        <div class="chart-bars" id="chart-bars"></div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Mes</th><th>Unidad</th><th>Lectura (mÂ³)</th><th>Consumo</th><th>Costo Est.</th><th>Registrado</th><th>Foto</th></tr></thead>
        <tbody id="hist-table"></tbody>
      </table></div>
    </div>

    <!-- REPORTE -->
    <div id="panel-reporte" class="panel">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;text-align:center">
        <div style="font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.25rem">Reporte del Edificio</div>
        <div style="font-family:var(--font-display);font-size:1.5rem;font-weight:800;color:var(--accent)" id="rep-mes-label">â€”</div>
        <div style="font-size:.82rem;color:var(--muted);margin-top:.2rem" id="rep-edif-nombre">â€”</div>
      </div>
      <div class="form-grid" style="margin-bottom:1.5rem">
        <div class="field"><label>MES DEL REPORTE</label><input type="month" id="rep-mes"/></div>
        <div class="field" style="justify-content:flex-end"><button class="btn btn-green" id="gen-rep-btn">âš¡ Generar</button></div>
      </div>
      <div id="reporte-body"></div>
    </div>

    <!-- CONFIG -->
    <div id="panel-config" class="panel">
      <div class="section-title">âš™ï¸ ConfiguraciÃ³n del Edificio</div>
      <div class="form-grid" style="margin-bottom:1.5rem">
        <div class="field"><label>NOMBRE DEL EDIFICIO</label><input type="text" id="cfg-nombre" placeholder="Ej: Edificio Las Palmas"/></div>
        <div class="field"><label>TARIFA REFERENCIAL MÂ³ ($)</label><input type="number" id="cfg-tarifa" placeholder="Ej: 850" step="0.01"/></div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem">
        <div style="font-size:.78rem;color:var(--muted);margin-bottom:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em">ğŸ“ Google Drive</div>
        <div style="font-size:.85rem;color:var(--muted);line-height:2">
          Carpeta: <strong style="color:var(--text)">AquaEdificio/</strong><br>
          Datos: <strong style="color:var(--text)">aquaedificio-data.json</strong><br>
          Fotos: <strong style="color:var(--text)">AquaEdificio/fotos/</strong>
        </div>
      </div>
      <div class="section-title">Unidades y Medidores</div>
      <div id="unidades-list" style="margin-bottom:1rem"></div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1rem">
        <div style="font-size:.85rem;color:var(--muted);margin-bottom:1rem;font-weight:500">AGREGAR UNIDAD</div>
        <div class="form-grid">
          <div class="field"><label>NOMBRE</label><input type="text" id="new-nombre" placeholder="Ej: Depto 21"/></div>
          <div class="field"><label>TIPO</label>
            <select id="new-tipo">
              <option value="remarc">Remarcador (compartido)</option>
              <option value="indep">Medidor Independiente</option>
              <option value="general">Medidor General</option>
              <option value="comun">Zonas Comunes</option>
            </select>
          </div>
          <div class="field" style="justify-content:flex-end"><button class="btn btn-green" id="add-unit-btn">+ Agregar</button></div>
        </div>
      </div>
      <div style="display:flex;gap:.75rem;flex-wrap:wrap">
        <button class="btn" id="save-cfg-btn">ğŸ’¾ Guardar en Drive</button>
        <button class="btn btn-ghost" id="sync-now-btn">ğŸ”„ Sincronizar</button>
      </div>
    </div>

  </div><!-- /app -->

  <!-- MODAL EDICIÃ“N -->
  <div id="modal-edit" style="display:none;position:fixed;inset:0;background:rgba(10,15,26,.88);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:2rem;width:90%;max-width:480px;position:relative">
      <div style="font-family:var(--font-display);font-size:1.1rem;font-weight:700;margin-bottom:1.25rem">âœï¸ Editar Lectura</div>
      <div style="font-size:.82rem;color:var(--muted);margin-bottom:1rem" id="edit-info"></div>
      <div class="form-grid" style="margin-bottom:1rem">
        <div class="field"><label>VALOR EN MÂ³</label><input type="number" id="edit-valor" step="0.01" min="0"/></div>
        <div class="field"><label>NOTAS</label><input type="text" id="edit-notas" placeholder="Opcional"/></div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.75rem;font-size:.78rem;color:var(--muted);margin-bottom:1.25rem">
        â„¹ï¸ El valor anterior quedarÃ¡ registrado en el historial de cambios
      </div>
      <div style="display:flex;gap:.75rem;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeEditModal()">Cancelar</button>
        <button class="btn btn-green" id="edit-save-btn">ğŸ’¾ Guardar cambio</button>
      </div>
    </div>
  </div>
</main>

<div class="loading-overlay" id="loading">
  <div class="spinner">â³</div>
  <div style="color:var(--muted);font-size:.9rem" id="loading-msg">Cargando...</div>
</div>
<div id="toast"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIGURACIÃ“N â€” completar despuÃ©s de crear proyecto en
//  Google Cloud Console (ver INSTRUCCIONES-DRIVE.md)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID    = '1074398752440-bcs0rvqkqs4clja6d849gjdafkhll5n8.apps.googleusercontent.com';
const FOLDER_NAME  = 'AquaEdificio';
const DATA_FILE    = 'aquaedificio-data.json';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let state = { config:{nombre:'Mi Edificio',tarifa:0,unidades:[]}, lecturas:{}, facturas:{} };
let currentUser = {nombre:'', email:''};
let currentMonth = new Date().toISOString().slice(0,7);
let fotoFile=null, fotoBase64=null;
let token=null, folderId=null, fotosFolderId=null, dataFileId=null;
let saveTimer=null;

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const ml = m=>{ if(!m)return'â€”'; const[y,mo]=m.split('-'); return MESES[+mo-1]+' '+y; };
const sortedMonths=()=>Object.keys(state.lecturas).sort();
function getConsumo(uid,mes){
  const ms=sortedMonths(), idx=ms.indexOf(mes), val=state.lecturas[mes]?.[uid]?.valor;
  if(val==null)return null;
  for(let i=idx-1;i>=0;i--){ const p=state.lecturas[ms[i]]?.[uid]?.valor; if(p!=null)return Math.max(0,val-p); }
  return null;
}
function getPrev(uid,mes){
  const ms=sortedMonths(), idx=ms.indexOf(mes);
  for(let i=idx-1;i>=0;i--){ const v=state.lecturas[ms[i]]?.[uid]?.valor; if(v!=null)return v; }
  return null;
}
function toast(msg,type='green'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.background=type==='red'?'var(--red)':type==='yellow'?'var(--yellow)':'var(--green)';
  t.style.color=type==='green'?'#000':'#fff'; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}
function loading(show,msg='Cargando...'){
  const el=document.getElementById('loading');
  document.getElementById('loading-msg').textContent=msg;
  el.classList.toggle('show',show);
}
function syncChip(st,msg){
  const c=document.getElementById('sync-chip'); c.style.display='flex';
  c.className='sync-chip sync-'+st; c.textContent=st==='ok'?'âœ“ '+msg:st==='pending'?'â†‘ '+msg:'âš  '+msg;
}

// â”€â”€ GOOGLE AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAuth(){
  if(typeof google==='undefined'){ setTimeout(initAuth,400); return; }
  const saved=sessionStorage.getItem('aq_tok');
  if(saved){ token=saved; onLoggedIn(); return; }
  google.accounts.id.initialize({ client_id:CLIENT_ID, callback:()=>requestToken() });
  google.accounts.id.prompt();
}
function requestToken(){
  const client=google.accounts.oauth2.initTokenClient({
    client_id:CLIENT_ID,
    scope:'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile',
    callback: async r=>{
      if(r.error){ toast('Error de autenticaciÃ³n','red'); return; }
      token=r.access_token; sessionStorage.setItem('aq_tok',token);
      await onLoggedIn();
    }
  });
  client.requestAccessToken();
}
async function onLoggedIn(){
  loading(true,'Conectando con Google Drive...');
  try {
    const u=await gf('https://www.googleapis.com/oauth2/v2/userinfo');
    currentUser={nombre:u.given_name||u.name||'Usuario',email:u.email||''};
    document.getElementById('user-avatar').src=u.picture;
    document.getElementById('user-avatar').style.display='block';
    document.getElementById('btn-logout').style.display='inline-flex';
    await ensureFolders();
    await loadData();
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('main-tabs').style.display='flex';
    syncChip('ok','Drive');
    initDefault(); renderAll();
  } catch(e){ toast('Error: '+e.message,'red'); console.error(e); }
  finally { loading(false); }
}
function signOut(){
  sessionStorage.removeItem('aq_tok'); token=null;
  ['app','main-tabs'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('user-avatar').style.display='none';
  document.getElementById('btn-logout').style.display='none';
  document.getElementById('sync-chip').style.display='none';
  if(typeof google!=='undefined') google.accounts.id.prompt();
}
document.getElementById('btn-login').addEventListener('click',requestToken);

// â”€â”€ DRIVE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gf(url,opts={}){
  const r=await fetch(url,{...opts,headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json',...(opts.headers||{})}});
  if(r.status===401){ signOut(); throw new Error('SesiÃ³n expirada'); }
  if(r.status===204)return null;
  if(!r.ok){ throw new Error('Drive API '+r.status); }
  return r.json();
}
async function findOrCreate(name,mime,parent=null){
  const parents=parent?`and '${parent}' in parents`:'';
  const q=`name='${name}' and mimeType='${mime}' ${parents} and trashed=false`;
  const r=await gf(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  if(r.files.length) return r.files[0].id;
  const body={name,mimeType:mime}; if(parent) body.parents=[parent];
  const f=await gf('https://www.googleapis.com/drive/v3/files',{method:'POST',body:JSON.stringify(body)});
  return f.id;
}
async function ensureFolders(){
  folderId=await findOrCreate(FOLDER_NAME,'application/vnd.google-apps.folder');
  fotosFolderId=await findOrCreate('fotos','application/vnd.google-apps.folder',folderId);
}
async function loadData(){
  const q=`name='${DATA_FILE}' and '${folderId}' in parents and trashed=false`;
  const r=await gf(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  if(!r.files.length) return;
  dataFileId=r.files[0].id;
  const res=await fetch(`https://www.googleapis.com/drive/v3/files/${dataFileId}?alt=media`,{headers:{'Authorization':'Bearer '+token}});
  state=await res.json();
}
async function saveData(){
  syncChip('pending','Guardando...');
  try {
    const blob=new Blob([JSON.stringify(state)],{type:'application/json'});
    const form=new FormData();
    form.append('metadata',new Blob([JSON.stringify(dataFileId?{name:DATA_FILE}:{name:DATA_FILE,parents:[folderId]})],{type:'application/json'}));
    form.append('file',blob);
    const url=dataFileId
      ?`https://www.googleapis.com/upload/drive/v3/files/${dataFileId}?uploadType=multipart`
      :'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
    const r=await fetch(url,{method:dataFileId?'PATCH':'POST',headers:{'Authorization':'Bearer '+token},body:form});
    const d=await r.json(); if(!dataFileId) dataFileId=d.id;
    syncChip('ok','Drive');
  } catch(e){ syncChip('error','Error'); toast('Error al guardar','red'); }
}
function scheduleSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveData,4000); syncChip('pending','Sin guardar'); }
async function uploadFoto(file,uid,mes){
  const compressed=await compressImg(file,1200,.78);
  const ext=file.name.split('.').pop()||'jpg', nombre=`${mes}_${uid}.${ext}`;
  // Remove old
  const q=`name='${nombre}' and '${fotosFolderId}' in parents and trashed=false`;
  const old=await gf(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id)`);
  for(const f of old.files) await gf(`https://www.googleapis.com/drive/v3/files/${f.id}`,{method:'DELETE'});
  // Upload
  const form=new FormData();
  form.append('metadata',new Blob([JSON.stringify({name:nombre,parents:[fotosFolderId]})],{type:'application/json'}));
  form.append('file',new Blob([compressed],{type:'image/jpeg'}));
  const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',headers:{'Authorization':'Bearer '+token},body:form});
  const d=await r.json();
  // Make public
  await gf(`https://www.googleapis.com/drive/v3/files/${d.id}/permissions`,{method:'POST',body:JSON.stringify({role:'reader',type:'anyone'})});
  return `https://lh3.googleusercontent.com/d/${d.id}`;
}
function compressImg(file,maxW,q){
  return new Promise(res=>{
    const rd=new FileReader(); rd.onload=e=>{
      const img=new Image(); img.onload=()=>{
        const r=Math.min(maxW/img.width,maxW/img.height,1);
        const c=document.createElement('canvas'); c.width=img.width*r; c.height=img.height*r;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        c.toBlob(b=>res(b),'image/jpeg',q);
      }; img.src=e.target.result;
    }; rd.readAsDataURL(file);
  });
}
document.getElementById('sync-now-btn').addEventListener('click',()=>{ clearTimeout(saveTimer); saveData(); });

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDefault(){
  if(state.config.unidades.length===0){
    state.config.unidades=[
      {id:'gen',nombre:'Medidor General',tipo:'general'},
      {id:'comun',nombre:'Zonas Comunes',tipo:'comun'},
      {id:'d11',nombre:'Depto 11 (Independiente)',tipo:'indep'},
      {id:'d12',nombre:'Depto 12',tipo:'remarc'},
      {id:'d21',nombre:'Depto 21',tipo:'remarc'},
      {id:'d22',nombre:'Depto 22',tipo:'remarc'},
      {id:'d31',nombre:'Depto 31',tipo:'remarc'},
      {id:'d32',nombre:'Depto 32',tipo:'remarc'},
      {id:'d41',nombre:'Depto 41',tipo:'remarc'},
      {id:'d42',nombre:'Depto 42',tipo:'remarc'},
    ];
    scheduleSave();
  }
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.getElementById('panel-'+t.dataset.panel).classList.add('active');
  renderAll();
}));
const updateML=()=>document.getElementById('monthLabel').textContent=ml(currentMonth);
document.getElementById('btn-prev').addEventListener('click',()=>{ const d=new Date(currentMonth+'-01'); d.setMonth(d.getMonth()-1); currentMonth=d.toISOString().slice(0,7); updateML(); renderDashboard(); });
document.getElementById('btn-next').addEventListener('click',()=>{ const d=new Date(currentMonth+'-01'); d.setMonth(d.getMonth()+1); currentMonth=d.toISOString().slice(0,7); updateML(); renderDashboard(); });
function renderAll(){ renderDashboard(); renderRegistroTable(); renderUnidadSelect(); renderHistorial(); renderConfig(); }

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mostrarIndep = true;
function toggleIndep(){
  mostrarIndep=!mostrarIndep;
  const knob=document.getElementById('toggle-knob'), wrap=document.getElementById('toggle-d11');
  if(mostrarIndep){
    knob.style.left='2px'; knob.style.background='var(--muted)'; wrap.style.background='var(--border)';
  } else {
    knob.style.left='18px'; knob.style.background='var(--accent)'; wrap.style.background='rgba(0,212,255,.25)';
  }
  renderDashboard();
}

function renderDashboard(){
  const u=state.config.unidades,m=currentMonth;
  const gen=u.find(x=>x.tipo==='general'),comun=u.find(x=>x.tipo==='comun'),indep=u.find(x=>x.tipo==='indep');
  const gc=gen?getConsumo(gen.id,m):null, gv=gen?state.lecturas[m]?.[gen.id]?.valor:null;
  const ic=indep?getConsumo(indep.id,m):null, cc=comun?getConsumo(comun.id,m):null, fac=state.facturas[m];
  document.getElementById('dash-general').textContent=gc!=null?gc.toFixed(2)+' mÂ³':'â€” mÂ³';
  document.getElementById('dash-general-sub').textContent=gv!=null?'Lectura: '+gv+' mÂ³':'Sin lectura este mes';
  document.getElementById('dash-indep').textContent=ic!=null?ic.toFixed(2)+' mÂ³':'â€” mÂ³';
  document.getElementById('dash-comun').textContent=cc!=null?cc.toFixed(2)+' mÂ³':'â€” mÂ³';
  document.getElementById('dash-total').textContent=fac?'$'+Number(fac).toLocaleString('es-CL'):'$â€”';
  document.getElementById('dash-tarifa-info').textContent=state.config.tarifa?'Tarifa: $'+state.config.tarifa+'/mÂ³':'Tarifa no configurada';
  const tipos={general:'<span class="badge badge-blue">General</span>',comun:'<span class="badge badge-yellow">ComÃºn</span>',indep:'<span class="badge badge-green">Independiente</span>',remarc:'<span class="badge" style="background:rgba(255,255,255,.06);color:var(--muted)">Remarcador</span>'};
  const tb=document.getElementById('estado-table'); tb.innerHTML='';
  u.forEach(un=>{
    if(un.tipo==='indep' && !mostrarIndep) return; // filtro toggle
    // Nombre limpio: sin "(Independiente)"
    const nombreMostrar = un.nombre.replace(/\s*\(independiente\)/i,'');
    const l=state.lecturas[m]?.[un.id], p=getPrev(un.id,m), c=getConsumo(un.id,m);
    tb.innerHTML+=`<tr><td><strong>${nombreMostrar}</strong></td><td>${tipos[un.tipo]||''}</td>
      <td style="font-family:var(--font-mono);color:var(--muted)">${p!=null?p+' mÂ³':'â€”'}</td>
      <td style="font-family:var(--font-mono)">${l?l.valor+' mÂ³':'<span style="color:var(--muted)">â€”</span>'}</td>
      <td style="font-family:var(--font-mono);color:var(--accent)">${c!=null?c.toFixed(2)+' mÂ³':'â€”'}</td>
      <td>${l?'<span style="color:var(--green)">âœ“ Ingresada</span>':'<span style="color:var(--red)">âš  Pendiente</span>'}</td></tr>`;
  });
}

// â”€â”€ REGISTRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUnidadSelect(){
  const s=document.getElementById('reg-unidad'); if(!s)return;
  const cv=s.value; s.innerHTML='';
  state.config.unidades.forEach(u=>s.innerHTML+=`<option value="${u.id}">${u.nombre}</option>`);
  if(cv) s.value=cv;
}
function renderRegistroTable(){
  const mes=document.getElementById('reg-mes')?.value||currentMonth;
  const tb=document.getElementById('reg-table'); if(!tb)return; tb.innerHTML=''; let any=false;
  state.config.unidades.forEach(un=>{
    const l=state.lecturas[mes]?.[un.id]; if(!l)return; any=true;
    const c=getConsumo(un.id,mes);
    const fh=l.foto?`<a href="${l.foto}" target="_blank"><img src="${l.foto}" style="height:36px;border-radius:4px;object-fit:cover" onerror="this.style.display='none'"></a>`:'<span style="color:var(--muted);font-size:.8rem">Sin foto</span>';
    const nomReg=un.nombre.replace(/\s*\(independiente\)/i,'');
    tb.innerHTML+=`<tr><td><strong>${nomReg}</strong></td>
      <td style="font-family:var(--font-mono);color:var(--accent)">${l.valor} mÂ³</td>
      <td style="font-family:var(--font-mono)">${c!=null?c.toFixed(2)+' mÂ³':'â€”'}</td>
      <td>${fh}</td>
      <td style="color:var(--muted);font-size:.85rem">${l.notas||'â€”'}</td>
      <td><button class="btn btn-ghost" style="padding:.3rem .6rem;font-size:.75rem;color:var(--accent);border-color:var(--accent)" onclick="openEditModal('${un.id}','${mes}')">âœï¸</button></td>
      <td><button class="btn btn-ghost" style="padding:.3rem .6rem;font-size:.75rem" onclick="borrarLectura('${un.id}','${mes}')">âœ•</button></td></tr>`;
  });
  if(!any) tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:1.5rem">No hay lecturas para este mes</td></tr>';
}
document.getElementById('foto-input').addEventListener('change',function(){
  const f=this.files[0]; if(!f)return; fotoFile=f;
  const rd=new FileReader(); rd.onload=e=>{ fotoBase64=e.target.result; document.getElementById('preview-img').src=fotoBase64; document.getElementById('foto-preview').style.display='block'; }; rd.readAsDataURL(f);
});
document.getElementById('clear-foto-btn').addEventListener('click',()=>{ fotoFile=null; fotoBase64=null; document.getElementById('foto-input').value=''; document.getElementById('foto-preview').style.display='none'; });
document.getElementById('save-lectura-btn').addEventListener('click',async()=>{
  const mes=document.getElementById('reg-mes').value, uid=document.getElementById('reg-unidad').value;
  const valor=parseFloat(document.getElementById('reg-valor').value), notas=document.getElementById('reg-notas').value;
  if(!mes||!uid||isNaN(valor)){ toast('Completa mes, unidad y valor','red'); return; }
  loading(true,'Guardando lectura...');
  try {
    let fotoUrl=null;
    if(fotoFile){ loading(true,'Subiendo foto a Drive...'); fotoUrl=await uploadFoto(fotoFile,uid,mes); }
    if(!state.lecturas[mes]) state.lecturas[mes]={};
    const ahora=new Date();
    state.lecturas[mes][uid]={valor,notas,foto:fotoUrl,ts:ahora.toISOString(),usuario:currentUser.nombre};
    await saveData(); toast('âœ“ Guardado en Drive');
    document.getElementById('reg-valor').value=''; document.getElementById('reg-notas').value='';
    fotoFile=null; fotoBase64=null; document.getElementById('foto-input').value='';
    document.getElementById('foto-preview').style.display='none';
    renderAll();
  } catch(e){ toast('Error: '+e.message,'red'); } finally { loading(false); }
});
document.getElementById('clear-form-btn').addEventListener('click',()=>{
  document.getElementById('reg-valor').value=''; document.getElementById('reg-notas').value='';
  fotoFile=null; fotoBase64=null; document.getElementById('foto-input').value='';
  document.getElementById('foto-preview').style.display='none';
});
document.getElementById('reg-mes').addEventListener('change',renderRegistroTable);
async function borrarLectura(uid,mes){
  if(!confirm('Â¿Borrar esta lectura?'))return;
  delete state.lecturas[mes]?.[uid];
  if(!Object.keys(state.lecturas[mes]||{}).length) delete state.lecturas[mes];
  await saveData(); renderAll();
}

// â”€â”€ EDICIÃ“N DE LECTURAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editCtx = {uid:null, mes:null};

function openEditModal(uid, mes){
  const l = state.lecturas[mes]?.[uid]; if(!l) return;
  const un = state.config.unidades.find(x=>x.id===uid);
  editCtx = {uid, mes};
  document.getElementById('edit-info').innerHTML =
    `<strong>${un?.nombre||uid}</strong> â€” ${ml(mes)}<br>Valor actual: <span style="color:var(--accent);font-family:var(--font-mono)">${l.valor} mÂ³</span>`;
  document.getElementById('edit-valor').value = l.valor;
  document.getElementById('edit-notas').value = l.notas||'';
  const modal = document.getElementById('modal-edit');
  modal.style.display='flex';
}

function closeEditModal(){
  document.getElementById('modal-edit').style.display='none';
  editCtx = {uid:null, mes:null};
}

document.getElementById('edit-save-btn').addEventListener('click', async()=>{
  const {uid, mes} = editCtx;
  if(!uid||!mes) return;
  const nuevoValor = parseFloat(document.getElementById('edit-valor').value);
  const nuevasNotas = document.getElementById('edit-notas').value;
  if(isNaN(nuevoValor)){ toast('Ingresa un valor vÃ¡lido','red'); return; }

  const lecturaActual = state.lecturas[mes]?.[uid];
  const valorAnterior = lecturaActual?.valor;

  // Guardar historial de cambios en la misma lectura
  const cambio = {
    valorAnterior,
    valorNuevo: nuevoValor,
    ts: new Date().toISOString(),
    usuario: currentUser.nombre
  };
  const histCambios = lecturaActual?.histCambios || [];
  histCambios.push(cambio);

  loading(true,'Guardando cambio...');
  try {
    state.lecturas[mes][uid] = {
      ...lecturaActual,
      valor: nuevoValor,
      notas: nuevasNotas,
      ts: new Date().toISOString(),
      usuario: currentUser.nombre,
      histCambios
    };
    await saveData();
    closeEditModal();
    toast('âœ“ Lectura actualizada');
    renderAll();
  } catch(e){ toast('Error: '+e.message,'red'); }
  finally { loading(false); }
});

// Cerrar modal al hacer clic fuera
document.getElementById('modal-edit').addEventListener('click', function(e){
  if(e.target===this) closeEditModal();
});

// â”€â”€ DISTRIBUCIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcDist(){
  const mes=document.getElementById('dist-mes').value, monto=parseFloat(document.getElementById('dist-monto').value);
  if(!mes)return;
  if(monto&&!isNaN(monto)){ state.facturas[mes]=monto; scheduleSave(); }

  const u=state.config.unidades;
  const gen=u.find(x=>x.tipo==='general');
  const remarcs=u.filter(x=>x.tipo==='remarc');
  const cont=document.getElementById('dist-container');

  // â”€â”€ Validaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const gc=gen?getConsumo(gen.id,mes):null;
  if(gc==null){ cont.innerHTML='<div style="padding:2rem;text-align:center;color:var(--red)">âš  Falta lectura del Medidor General</div>'; return; }

  const fv=state.facturas[mes]||null;
  // $/mÂ³ se calcula sobre el total del medidor general
  const cpm=fv&&gc>0?fv/gc:(state.config.tarifa||0);

  // â”€â”€ Consumos remarcadores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rd=remarcs.map(r=>({...r,cons:getConsumo(r.id,mes)||0}));
  const totalRemarc=rd.reduce((s,r)=>s+r.cons,0);

  // â”€â”€ Diferencia = General - suma remarcadores â”€â”€â”€â”€â”€â”€
  // (incluye pÃ©rdidas, zonas comunes, depto 11 â€” todo
  //  lo que no estÃ¡ en los remarcadores se distribuye
  //  proporcionalmente entre ellos)
  const diferencia=gc-totalRemarc;
  const pt=totalRemarc||1;

  // â”€â”€ Construir filas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let data=[];
  rd.forEach(r=>{
    const peso=pt>0?r.cons/pt:1/rd.length;
    const costoPropio=r.cons*cpm;
    const costoDiff=diferencia*cpm*peso;  // absorbe su parte de la diferencia
    data.push({
      n:r.nombre, c:r.cons, t:'remarc',
      cost:costoPropio+costoDiff,
      sub:`Consumo propio: $${Math.round(costoPropio).toLocaleString('es-CL')} + Diferencia: $${Math.round(costoDiff).toLocaleString('es-CL')}`
    });
  });

  // Fila informativa de diferencia (no se cobra, es informativa)
  const mx=Math.max(...data.map(d=>Math.abs(d.c)),1);
  const tot=data.reduce((s,x)=>s+x.cost,0);

  // â”€â”€ Encabezado resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html=`<div style="padding:1rem;display:flex;gap:1.5rem;flex-wrap:wrap;font-size:.82rem;color:var(--muted);border-bottom:1px solid var(--border)">
    <span>ğŸ“Š General: <strong style="color:var(--text)">${gc.toFixed(2)} mÂ³</strong></span>
    <span>ğŸ  Remarcadores: <strong style="color:var(--text)">${totalRemarc.toFixed(2)} mÂ³</strong></span>
    ${Math.abs(diferencia)>0.01?`<span>âš¡ Diferencia: <strong style="color:${diferencia>=0?'var(--yellow)':'var(--red)'}">${diferencia>=0?'+':''}${diferencia.toFixed(2)} mÂ³</strong></span>`:''}
    ${fv?`<span>ğŸ’° Factura: <strong style="color:var(--green)">$${Number(fv).toLocaleString('es-CL')}</strong></span>`:''}
    ${cpm?`<span>ğŸ’§ $/mÂ³: <strong style="color:var(--accent)">$${cpm.toFixed(0)}</strong></span>`:''}
  </div>`;

  // â”€â”€ Filas por departamento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  data.forEach(d=>{
    const pct=mx>0?d.c/mx*100:0;
    html+=`<div class="dist-row">
      <div class="dist-name">${d.n}<div style="font-size:.72rem;color:var(--muted);margin-top:.2rem">${d.sub}</div></div>
      <div class="dist-bar-wrap"><div class="dist-bar" style="width:${pct}%;background:var(--accent)"></div></div>
      <div class="dist-m3">${d.c.toFixed(2)} mÂ³</div>
      <div class="dist-pct">${totalRemarc>0?(d.c/totalRemarc*100).toFixed(1)+'%':'â€”'}</div>
      <div class="dist-monto">${cpm?'$'+Math.round(d.cost).toLocaleString('es-CL'):'â€”'}</div>
    </div>`;
  });

  // â”€â”€ Totales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(cpm&&fv){
    const diff=fv-tot;
    html+=`<div style="padding:.9rem 1rem;border-top:1px solid var(--border);display:flex;gap:1.5rem;flex-wrap:wrap;font-size:.82rem;color:var(--muted)">
      <span>Total cobros: <strong style="color:var(--green)">$${Math.round(tot).toLocaleString('es-CL')}</strong></span>
      <span>Factura: <strong style="color:var(--text)">$${Number(fv).toLocaleString('es-CL')}</strong></span>
      ${Math.abs(diff)>1?`<span style="color:${Math.abs(diff)<500?'var(--yellow)':'var(--red)'}">Î” $${Math.round(Math.abs(diff)).toLocaleString('es-CL')} por redondeo</span>`:'<span style="color:var(--green)">âœ“ Cuadra exacto</span>'}
    </div>`;
  }

  cont.innerHTML=html;
  ['export-btn','share-btn'].forEach(id=>document.getElementById(id).style.display='inline-flex');
  renderDashboard();
}
document.getElementById('calc-btn').addEventListener('click',calcDist);
document.getElementById('dist-mes').addEventListener('change',calcDist);
document.getElementById('export-btn').addEventListener('click',()=>{
  const mes=document.getElementById('dist-mes').value, txt=document.getElementById('dist-container').innerText;
  const b=new Blob([`DISTRIBUCIÃ“N DE AGUA â€” ${ml(mes)}\n${'='.repeat(40)}\n${txt}`],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`distribucion-${mes}.txt`; a.click();
});

document.getElementById('export-pdf-btn').addEventListener('click',()=>{
  const mes = document.getElementById('dist-mes').value;
  const edificio = state.config.nombre;
  const u = state.config.unidades;
  const gen = u.find(x=>x.tipo==='general');
  const remarcs = u.filter(x=>x.tipo==='remarc');
  const gc = gen ? getConsumo(gen.id,mes) : null;
  const fvNum = state.facturas[mes]||null;
  const cpm = fvNum&&gc>0 ? fvNum/gc : (state.config.tarifa||0);
  const rd = remarcs.map(r=>({...r,cons:getConsumo(r.id,mes)||0}));
  const totalRemarc = rd.reduce((s,r)=>s+r.cons,0);
  const diferencia = gc ? gc-totalRemarc : 0;
  const pt = totalRemarc||1;

  // Calcular cobros
  let totalCobros = 0;
  const filas = rd.map(r=>{
    const peso = pt>0 ? r.cons/pt : 1/rd.length;
    const cost = r.cons*cpm + diferencia*cpm*peso;
    totalCobros += cost;
    const pct = totalRemarc>0 ? (r.cons/totalRemarc*100).toFixed(1) : 0;
    const barW = totalRemarc>0 ? Math.round(r.cons/totalRemarc*100) : 0;
    return {nombre:r.nombre, cons:r.cons, cost, pct, barW};
  });

  // Construir HTML como string simple (sin template literals anidados)
  const css = [
    '*{margin:0;padding:0;box-sizing:border-box}',
    'body{font-family:Segoe UI,Arial,sans-serif;background:#fff;color:#1a1a2e;padding:2rem;font-size:13px}',
    'h1{font-size:1.4rem;font-weight:800;color:#0a0f1a}',
    'h2{font-size:.95rem;color:#6b7a99;margin-top:.2rem}',
    '.mes{font-size:1.05rem;font-weight:700;color:#00d4ff;margin-top:.3rem}',
    '.header{text-align:center;border-bottom:3px solid #00d4ff;padding-bottom:1rem;margin-bottom:1.5rem}',
    '.summary{display:flex;gap:.75rem;margin-bottom:1.5rem;flex-wrap:wrap}',
    '.sc{flex:1;min-width:90px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:.7rem;text-align:center}',
    '.sc .l{font-size:.62rem;text-transform:uppercase;letter-spacing:.05em;color:#6b7a99}',
    '.sc .v{font-size:1.05rem;font-weight:700;margin-top:.2rem;font-family:monospace}',
    'table{width:100%;border-collapse:collapse;margin-bottom:1rem}',
    'th{background:#0a0f1a;color:#fff;padding:.6rem .9rem;text-align:left;font-size:.72rem;text-transform:uppercase;letter-spacing:.05em}',
    'td{padding:.7rem .9rem;border-bottom:1px solid #e2e8f0;font-size:.85rem}',
    'tr:nth-child(even) td{background:#f8fafc}',
    '.monto{font-family:monospace;font-weight:700;font-size:1rem;color:#059669;text-align:right}',
    '.cons{font-family:monospace;color:#0095ff;text-align:right}',
    '.pct-cell{color:#6b7a99;font-size:.8rem;text-align:right}',
    '.bar-bg{background:#e2e8f0;height:5px;border-radius:99px;overflow:hidden;width:70px;display:inline-block;vertical-align:middle;margin-right:4px}',
    '.bar-fill{height:100%;border-radius:99px;background:#00d4ff}',
    '.tr-total{background:#f0fdf4!important;font-weight:700}',
    '.tr-total td{border-top:2px solid #059669}',
    '.footer{margin-top:1.5rem;text-align:center;font-size:.7rem;color:#9ca3af;border-top:1px solid #e2e8f0;padding-top:1rem}',
    '@media print{body{padding:1rem}.footer{position:fixed;bottom:0;width:100%}}'
  ].join('');

  let rows = '';
  filas.forEach(function(f){
    rows += '<tr>';
    rows += '<td><strong>' + f.nombre + '</strong></td>';
    rows += '<td class="cons">' + f.cons.toFixed(2) + ' mÂ³</td>';
    rows += '<td class="pct-cell"><div class="bar-bg"><div class="bar-fill" style="width:' + f.barW + '%"></div></div> ' + f.pct + '%</td>';
    rows += '<td class="monto">' + (cpm ? '$' + Math.round(f.cost).toLocaleString('es-CL') : 'â€”') + '</td>';
    rows += '</tr>';
  });

  const summCards = [
    ['Medidor General', (gc ? gc.toFixed(2) : 'â€”') + ' mÂ³', '#0a0f1a'],
    ['Remarcadores', totalRemarc.toFixed(2) + ' mÂ³', '#0a0f1a'],
    ['Diferencia', (diferencia >= 0 ? '+' : '') + diferencia.toFixed(2) + ' mÂ³', Math.abs(diferencia) < 1 ? '#059669' : '#f59e0b']
  ];
  if(fvNum) summCards.push(['Factura Total', '$' + Number(fvNum).toLocaleString('es-CL'), '#059669']);
  if(cpm)   summCards.push(['$/mÂ³', '$' + cpm.toFixed(0), '#0095ff']);

  let cards = '';
  summCards.forEach(function(sc){
    cards += '<div class="sc"><div class="l">' + sc[0] + '</div><div class="v" style="color:' + sc[2] + '">' + sc[1] + '</div></div>';
  });

  const fecha = new Date().toLocaleDateString('es-CL', {day:'2-digit',month:'2-digit',year:'numeric'})
              + ' ' + new Date().toLocaleTimeString('es-CL', {hour:'2-digit',minute:'2-digit'});

  const html = '<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">'
    + '<title>Distribucion ' + ml(mes) + '</title>'
    + '<style>' + css + '</style></head><body>'
    + '<div class="header"><h1>&#128167; ' + edificio + '</h1>'
    + '<h2>DistribuciÃ³n de Consumo de Agua</h2>'
    + '<div class="mes">' + ml(mes) + '</div></div>'
    + '<div class="summary">' + cards + '</div>'
    + '<table><thead><tr>'
    + '<th>Departamento</th><th>Consumo (mÂ³)</th><th>% del Total</th><th>Cobro ($)</th>'
    + '</tr></thead><tbody>' + rows
    + '<tr class="tr-total"><td colspan="3"><strong>TOTAL</strong></td>'
    + '<td class="monto">' + (cpm ? '$' + Math.round(totalCobros).toLocaleString('es-CL') : 'â€”') + '</td></tr>'
    + '</tbody></table>'
    + '<div class="footer">Generado por AquaEdificio &middot; ' + fecha + '</div>'
    + '</body></html>';

  const win = window.open('','_blank');
  win.document.open();
  win.document.write(html);
  win.document.close();
  setTimeout(function(){ win.print(); }, 400);
});

document.getElementById('share-btn').addEventListener('click',()=>{
  const url=location.href.split('?')[0]+'?rep='+document.getElementById('dist-mes').value;
  navigator.clipboard.writeText(url).then(()=>toast('ğŸ”— Link copiado'));
});

// â”€â”€ HISTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtTs(ts){
  if(!ts) return 'â€”';
  const d=new Date(ts);
  return d.toLocaleDateString('es-CL',{day:'2-digit',month:'2-digit',year:'numeric'})+' '+d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
}

function renderHistorial(){
  const gen=state.config.unidades.find(x=>x.tipo==='general'), meses=sortedMonths().slice(-6);
  if(gen&&meses.length>1){
    document.getElementById('chart-wrap').style.display='block';
    const maxC=Math.max(...meses.map(m=>getConsumo(gen.id,m)||0),1);
    document.getElementById('chart-bars').innerHTML=meses.map(m=>{ const c=getConsumo(gen.id,m)||0, h=Math.round(c/maxC*100);
      return `<div class="chart-col"><div class="chart-val">${c>0?c.toFixed(0):''}</div><div class="chart-bar" style="height:${h}%"></div><div class="chart-lbl">${ml(m).slice(0,3)}</div></div>`; }).join('');
  }
  const tb=document.getElementById('hist-table'); if(!tb)return; tb.innerHTML=''; let any=false;
  sortedMonths().reverse().forEach(mes=>{
    state.config.unidades.forEach(un=>{
      const l=state.lecturas[mes]?.[un.id]; if(!l)return; any=true;
      const c=getConsumo(un.id,mes), gen2=state.config.unidades.find(x=>x.tipo==='general');
      const gc=gen2?getConsumo(gen2.id,mes):null, fac=state.facturas[mes], cpm=fac&&gc?fac/gc:(state.config.tarifa||0);
      const fh=l.foto?`<a href="${l.foto}" target="_blank"><img src="${l.foto}" style="height:30px;border-radius:4px;object-fit:cover" onerror="this.style.display='none'"></a>`:'â€”';
      const nomHist=un.nombre.replace(/\s*\(independiente\)/i,'');
      const cambios = l.histCambios?.length ? `<div style="font-size:.7rem;color:var(--yellow);margin-top:.2rem">âœï¸ ${l.histCambios.length} ediciÃ³n${l.histCambios.length>1?'es':''}</div>` : '';
      const tsHtml=`<div style="font-size:.78rem;color:var(--muted);white-space:nowrap">${fmtTs(l.ts)}</div>${l.usuario?`<div style="font-size:.72rem;color:var(--accent)">ğŸ‘¤ ${l.usuario}</div>`:''}${cambios}`;
      tb.innerHTML+=`<tr><td><span class="badge badge-blue">${ml(mes)}</span></td><td>${nomHist}</td>
        <td style="font-family:var(--font-mono)">${l.valor} mÂ³</td>
        <td style="font-family:var(--font-mono);color:var(--accent)">${c!=null?c.toFixed(2)+' mÂ³':'â€”'}</td>
        <td style="font-family:var(--font-mono);color:var(--green)">${(c&&cpm)?'$'+Math.round(c*cpm).toLocaleString('es-CL'):'â€”'}</td>
        <td>${tsHtml}</td>
        <td>${fh}</td></tr>`;
    });
  });
  if(!any) tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:2rem">Sin historial aÃºn</td></tr>';
}

// â”€â”€ REPORTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('gen-rep-btn').addEventListener('click',genReporte);
document.getElementById('rep-mes').addEventListener('change',genReporte);
function genReporte(){
  const mes=document.getElementById('rep-mes').value; if(!mes)return;
  document.getElementById('rep-mes-label').textContent=ml(mes);
  document.getElementById('rep-edif-nombre').textContent=state.config.nombre;
  const u=state.config.unidades, gen=u.find(x=>x.tipo==='general'), comun=u.find(x=>x.tipo==='comun'), indep=u.find(x=>x.tipo==='indep'), remarcs=u.filter(x=>x.tipo==='remarc');
  const gc=gen?getConsumo(gen.id,mes):null, fv=state.facturas[mes];
  const cpm=fv&&gc>0?fv/gc:(state.config.tarifa||0);
  const rd=remarcs.map(r=>({...r,cons:getConsumo(r.id,mes)||0}));
  const totalRemarc=rd.reduce((s,r)=>s+r.cons,0);
  const diferencia=gc?gc-totalRemarc:0;
  const pt=totalRemarc||1;
  const cont=document.getElementById('reporte-body');
  if(!gc){ cont.innerHTML='<div style="text-align:center;color:var(--muted);padding:2rem">Sin datos para este mes</div>'; return; }
  let html=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:1.5rem">
    ${[['Total general',gc.toFixed(2)+' mÂ³','var(--text)'],['Remarcadores',totalRemarc.toFixed(2)+' mÂ³','var(--text)'],['Factura total',fv?'$'+Number(fv).toLocaleString('es-CL'):'â€”','var(--green)'],['$/mÂ³',cpm?'$'+cpm.toFixed(0):'â€”','var(--accent)']].map(([l,v,col])=>`<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1rem;text-align:center"><div style="font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em">${l}</div><div style="font-family:var(--font-mono);font-size:1.3rem;color:${col};margin-top:.25rem">${v}</div></div>`).join('')}
  </div><div class="section-title">Cobro por departamento</div>`;
  rd.forEach(r=>{
    const peso=pt>0?r.cons/pt:1/rd.length;
    const cost=r.cons*cpm + diferencia*cpm*peso;
    html+=`<div class="cobro-card"><div><div class="cobro-nombre">${r.nombre}</div><div class="cobro-detalle">${r.cons.toFixed(2)} mÂ³ Â· ${totalRemarc>0?(r.cons/totalRemarc*100).toFixed(1):0}% del total remarcado</div></div><div class="cobro-monto">$${Math.round(cost).toLocaleString('es-CL')}</div></div>`;
  });
  const totalCobros=rd.reduce((s,r)=>{ const p=pt>0?r.cons/pt:1/rd.length; return s+r.cons*cpm+diferencia*cpm*p; },0);
  if(fv) html+=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1rem 1.25rem;margin-top:.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem"><span style="font-size:.82rem;color:var(--muted)">Total cobros asignados</span><span style="font-family:var(--font-mono);font-weight:700;color:var(--green);font-size:1.1rem">$${Math.round(totalCobros).toLocaleString('es-CL')}</span></div>`;
  cont.innerHTML=html;
}

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderConfig(){
  const n=document.getElementById('cfg-nombre'); if(!n)return;
  n.value=state.config.nombre; document.getElementById('cfg-tarifa').value=state.config.tarifa||'';
  const tipos={general:'General',comun:'ComÃºn',indep:'Independiente',remarc:'Remarcador'};
  document.getElementById('unidades-list').innerHTML=`<div class="table-wrap"><table>
    <thead><tr><th>Nombre</th><th>Tipo</th><th></th></tr></thead>
    <tbody>${state.config.unidades.map((u,i)=>`<tr><td>${u.nombre}</td><td><span class="badge badge-blue">${tipos[u.tipo]||u.tipo}</span></td>
      <td><button class="btn btn-ghost" style="padding:.3rem .6rem;font-size:.75rem;color:var(--red);border-color:var(--red)" onclick="delUnidad(${i})">âœ•</button></td></tr>`).join('')}
    </tbody></table></div>`;
}
document.getElementById('add-unit-btn').addEventListener('click',()=>{
  const n=document.getElementById('new-nombre').value.trim(), t=document.getElementById('new-tipo').value;
  if(!n){ toast('Ingresa un nombre','red'); return; }
  state.config.unidades.push({id:'u'+Date.now(),nombre:n,tipo:t});
  scheduleSave(); renderAll(); document.getElementById('new-nombre').value=''; toast('âœ“ Unidad agregada');
});
function delUnidad(i){
  if(!confirm('Â¿Borrar esta unidad?'))return;
  const uid=state.config.unidades[i].id; state.config.unidades.splice(i,1);
  Object.keys(state.lecturas).forEach(m=>{ delete state.lecturas[m][uid]; });
  scheduleSave(); renderAll();
}
document.getElementById('save-cfg-btn').addEventListener('click',async()=>{
  state.config.nombre=document.getElementById('cfg-nombre').value;
  state.config.tarifa=parseFloat(document.getElementById('cfg-tarifa').value)||0;
  loading(true,'Guardando...'); await saveData(); loading(false); toast('âœ“ ConfiguraciÃ³n guardada'); renderAll();
});

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('reg-mes').value=currentMonth;
document.getElementById('dist-mes').value=currentMonth;
document.getElementById('rep-mes').value=currentMonth;
updateML();
window.addEventListener('load',initAuth);
// Handle ?rep= param for shared report link
const p=new URLSearchParams(location.search).get('rep');
if(p){ document.getElementById('rep-mes').value=p; }
</script>
</body>
</html>
